version: '3.3'

services:

Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:5.6.0
    environment:
      #- bootstrap.memory_lock=true
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms640m -Xmx640m
      
 #untuk batasan resource dapat menggunakan seperti contoh di bawah
        
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1024M
        reservations:
          cpus: '0.25'
          memory: 512M
      mode: global
      
    ports:
      - 63002:9200
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - net_search

#percona_database
  percona:
    image: percona:5.6
    environment:
      - MYSQL_ROOT_PASSWORD=my-secret-pw
      - MYSQL_DATABASE=atom
      - MYSQL_USER=atom
      - MYSQL_PASSWORD=atom_12345
    volumes:
      - percona_data:/var/lib/mysql:rw
      # cek penulisan volume
      - ./etc/mysql/conf.d/:/etc/mysql/conf.d:ro
    #expose:
    #  - 3306
    networks:
      - net_db
#memcached
  memcached:
    image: memcached
    command: -p 11211 -m 128 -u memcache
    #expose:
    #  - 11211
    networks:
      - net_cache
      - net_jobs
#gearmand
  gearmand:
    image: artefactual/gearmand
    #expose:
    #  - 4730
    networks:
      - net_cache
      - net_jobs  
  
  #Atom
  #atom:
  #  build:
  #    context: ../
  #    dockerfile: ./docker/Dockerfile
  #  command: fpm
  #  volumes:
  #    - ../:/atom/src:rw
  #  networks:
  #    - net_cache
  #    - net_db
  #    - net_http
  #    - net_jobs
  #    - net_search
  #  environment:
  #    - ATOM_DEVELOPMENT_MODE=on
  #    - ATOM_ELASTICSEARCH_HOST=elasticsearch
  #    - ATOM_MEMCACHED_HOST=memcached
  #    - ATOM_GEARMAND_HOST=gearmand
  #    - ATOM_MYSQL_DSN=mysql:host=percona;port=3306;dbname=atom;charset=utf8
  #    - ATOM_MYSQL_USERNAME=atom
  #    - ATOM_MYSQL_PASSWORD=atom_12345
  #    - ATOM_DEBUG_IP=172.22.0.1
      
volumes:
  percona_data:
    driver: local
  elasticsearch_data:
    driver: local

networks:
  net_cache:
    driver: overlay
  net_db:
    driver: overlay
  net_jobs:
    driver: overlay
  net_http:
    driver: overlay
  net_search:
    driver: overlay
